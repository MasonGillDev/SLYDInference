<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLYD vLLM Control Panel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="topbar">
        <div class="nav-content">
            <div class="logo-section" style="display: flex; align-items: center;">
                <img src="https://www.slyd.com/images/SLYD-logo-300x86.webp" alt="SLYD Logo" style="height: 40px; margin-right: 20px;">
                <h1 style="color: white; margin: 0; font-size: 1.5rem; font-weight: 500;">vLLM Control Panel</h1>
            </div>
            <div class="nav-links">
                <a href="https://docs.vllm.ai/en/latest/serving/openai_compatible_server.html" target="_blank" class="docs-link">API Docs</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container" style="max-width: 1600px;">

        <!-- Top Grid: Model, Network, Performance -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 1.5rem;">
            
            <!-- Model Information Section -->
            <div class="card">
                <h2 class="section-title">üì¶ Active Model</h2>
                <div style="padding: 0.5rem 0;">
                    <p style="font-size: 1.1rem; color: var(--primary-color); margin: 0.5rem 0; font-weight: 500;">
                        {{ vllm_config.model }}
                    </p>
                    <small class="helper-text" style="display: block; margin-top: 0.5rem;">To change the model, edit vllm_config.json directly</small>
                    
                    <!-- HuggingFace Token Section -->
                    <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <label for="hf-token" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">HuggingFace Token</label>
                        <div class="input-with-button">
                            <input type="password" 
                                   id="hf-token" 
                                   placeholder="hf_..." 
                                   value="{{ masked_token }}"
                                   class="input-field flex-1"
                                   style="font-family: monospace;">
                            <button type="button" class="btn-primary" onclick="saveHFToken()">Save Token</button>
                        </div>
                        <small class="helper-text">Required for gated models. Token is stored securely.</small>
                        <div id="token-status" class="status-message" style="margin-top: 0.5rem; display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="card">
                <h2 class="section-title">üéõÔ∏è Control Panel</h2>
                <button type="button" class="btn-primary" onclick="saveConfig()" style="width: 100%; margin-bottom: 0.5rem;">
                    Save Configuration
                </button>
                <button type="button" class="btn-secondary" onclick="restartService()" style="width: 100%; margin-bottom: 0.5rem;">
                    Restart Service
                </button>
                <button type="button" class="btn-secondary" onclick="checkServiceStatus()" style="width: 100%; margin-bottom: 0.5rem;">
                    Check Status
                </button>
                <button type="button" class="btn-secondary" onclick="resetToDefaults()" style="width: 100%; background-color: #dc2626;">
                    Reset to Default Config
                </button>
                <div id="service-status" class="status-message" style="margin-top: 1rem;"></div>
            </div>
            
            <!-- Performance Configuration Section (Compact) -->
            <div class="card">
                <h2 class="section-title">‚ö° Performance</h2>
                <div class="form-group">
                    <label for="gpu-memory">GPU Memory</label>
                    <input type="number"
                           id="gpu-memory"
                           value="{{ vllm_config.gpu_memory_utilization }}"
                           step="0.05"
                           min="0.1"
                           max="1.0"
                           class="input-field">
                    <small class="helper-text">0.1 to 1.0</small>
                </div>
                <div class="form-group">
                    <label for="max-num-seqs">Max Sequences</label>
                    <input type="number"
                           id="max-num-seqs"
                           value="{{ vllm_config.max_num_seqs }}"
                           min="1"
                           max="256"
                           class="input-field">
                    <small class="helper-text">Concurrent requests</small>
                </div>
            </div>
            
        </div> <!-- End top grid -->

        <!-- Second Grid: Model & Hardware Settings -->
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 1.5rem;">
            
            <div class="card">
                <h2 class="section-title">üìä Model Configuration</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="max-model-len">Max Model Length</label>
                        <input type="number"
                               id="max-model-len"
                               value="{{ vllm_config.max_model_len }}"
                               min="128"
                               max="131072"
                               class="input-field">
                        <small class="helper-text">Maximum context length</small>
                    </div>
                    <div class="form-group">
                        <label for="dtype">Data Type</label>
                        <select id="dtype" class="input-field">
                            <option value="auto" {% if vllm_config.dtype == 'auto' %}selected{% endif %}>auto</option>
                            <option value="float16" {% if vllm_config.dtype == 'float16' %}selected{% endif %}>float16</option>
                            <option value="bfloat16" {% if vllm_config.dtype == 'bfloat16' %}selected{% endif %}>bfloat16</option>
                            <option value="float32" {% if vllm_config.dtype == 'float32' %}selected{% endif %}>float32</option>
                        </select>
                        <small class="helper-text">Model precision</small>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="section-title">üñ•Ô∏è Hardware & Security</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="tensor-parallel">Tensor Parallel Size</label>
                        <input type="number"
                               id="tensor-parallel"
                               value="{{ vllm_config.tensor_parallel_size }}"
                               min="1"
                               max="8"
                               class="input-field">
                        <small class="helper-text">Number of GPUs to use</small>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox"
                                   id="trust-remote-code"
                                   {% if vllm_config.trust_remote_code %}checked{% endif %}>
                            <span>Trust Remote Code</span>
                        </label>
                        <small class="helper-text">Allow custom model code</small>
                    </div>
                </div>
            </div>
            
        </div>

        <!-- Advanced Options Section (Collapsible) -->
        <div class="card">
            <h2 class="section-title" style="cursor: pointer; user-select: none;" onclick="toggleAdvancedOptions()">
                <span id="advanced-arrow" style="display: inline-block; transition: transform 0.3s;">‚ñ∂</span>
                ‚öôÔ∏è Advanced Options
            </h2>
            
            <div id="advanced-options" style="display: none;">
                <!-- Quantization and Optimization -->
                <h3 style="margin-top: 1.5rem; margin-bottom: 1rem; color: var(--text-primary);">Optimization Settings</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="quantization">Quantization</label>
                        <select id="quantization" class="input-field">
                            <option value="null" {% if not vllm_config.quantization %}selected{% endif %}>None</option>
                            <option value="awq" {% if vllm_config.quantization == 'awq' %}selected{% endif %}>AWQ</option>
                            <option value="gptq" {% if vllm_config.quantization == 'gptq' %}selected{% endif %}>GPTQ</option>
                            <option value="squeezellm" {% if vllm_config.quantization == 'squeezellm' %}selected{% endif %}>SqueezeLLM</option>
                            <option value="fp8" {% if vllm_config.quantization == 'fp8' %}selected{% endif %}>FP8</option>
                        </select>
                        <small class="helper-text">Model quantization method</small>
                    </div>

                    <div class="form-group">
                        <label for="seed">Random Seed</label>
                        <input type="number"
                               id="seed"
                               value="{{ vllm_config.seed }}"
                               min="0"
                               class="input-field">
                        <small class="helper-text">0 for random (default: 0)</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="swap-space">Swap Space (GB)</label>
                        <input type="number"
                               id="swap-space"
                               value="{{ vllm_config.swap_space }}"
                               min="0"
                               max="64"
                               class="input-field">
                        <small class="helper-text">CPU swap space per GPU (default: 4)</small>
                    </div>

                    <div class="form-group">
                        <label for="block-size">Block Size</label>
                        <input type="number"
                               id="block-size"
                               value="{{ vllm_config.block_size }}"
                               min="8"
                               max="32"
                               step="8"
                               class="input-field">
                        <small class="helper-text">Token block size (8, 16, or 32)</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox"
                                   id="enable-prefix-caching"
                                   {% if vllm_config.enable_prefix_caching %}checked{% endif %}>
                            <span>Enable Prefix Caching</span>
                        </label>
                        <small class="helper-text">Cache prompt prefixes for faster inference</small>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox"
                                   id="enable-chunked-prefill"
                                   {% if vllm_config.enable_chunked_prefill %}checked{% endif %}>
                            <span>Enable Chunked Prefill</span>
                        </label>
                        <small class="helper-text">Split prefill into smaller chunks</small>
                    </div>
                </div>

                <!-- Batching and Scheduling -->
                <h3 style="margin-top: 1.5rem; margin-bottom: 1rem; color: var(--text-primary);">Batching & Scheduling</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="max-num-batched-tokens">Max Batched Tokens</label>
                        <input type="number"
                               id="max-num-batched-tokens"
                               value="{{ vllm_config.max_num_batched_tokens or '' }}"
                               placeholder="Auto"
                               min="1"
                               class="input-field">
                        <small class="helper-text">Max tokens per batch (empty for auto)</small>
                    </div>
                </div>

                <!-- Tokenizer Settings -->
                <h3 style="margin-top: 1.5rem; margin-bottom: 1rem; color: var(--text-primary);">Tokenizer Settings</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="tokenizer">Custom Tokenizer</label>
                        <input type="text"
                               id="tokenizer"
                               value="{{ vllm_config.tokenizer or '' }}"
                               placeholder="Use model's tokenizer"
                               class="input-field">
                        <small class="helper-text">Override model tokenizer</small>
                    </div>
                </div>

                <!-- API Settings -->
                <h3 style="margin-top: 1.5rem; margin-bottom: 1rem; color: var(--text-primary);">API Settings</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="chat-template">Chat Template</label>
                        <input type="text"
                               id="chat-template"
                               value="{{ vllm_config.chat_template or '' }}"
                               placeholder="Auto-detect from model"
                               class="input-field">
                        <small class="helper-text">Override chat template</small>
                    </div>

                    <div class="form-group">
                        <label for="response-role">Response Role</label>
                        <input type="text"
                               id="response-role"
                               value="{{ vllm_config.response_role }}"
                               class="input-field">
                        <small class="helper-text">Role name in chat responses</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="served-model-name">Served Model Name</label>
                        <input type="text"
                               id="served-model-name"
                               value="{{ vllm_config.served_model_name or '' }}"
                               placeholder="Use actual model name"
                               class="input-field">
                        <small class="helper-text">Override model name in API</small>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox"
                                   id="disable-log-stats"
                                   {% if vllm_config.disable_log_stats %}checked{% endif %}>
                            <span>Disable Log Stats</span>
                        </label>
                        <small class="helper-text">Disable performance logging</small>
                    </div>
                </div>

                <!-- LoRA Settings -->
                <h3 style="margin-top: 1.5rem; margin-bottom: 1rem; color: var(--text-primary);">LoRA Settings</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox"
                                   id="enable-lora"
                                   {% if vllm_config.enable_lora %}checked{% endif %}
                                   onchange="toggleLoraOptions()">
                            <span>Enable LoRA</span>
                        </label>
                        <small class="helper-text">Enable LoRA adapter support</small>
                    </div>
                </div>

                <div id="lora-options" style="{% if not vllm_config.enable_lora %}display: none;{% endif %}">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="max-loras">Max LoRAs</label>
                            <input type="number"
                                   id="max-loras"
                                   value="{{ vllm_config.max_loras }}"
                                   min="1"
                                   max="64"
                                   class="input-field">
                            <small class="helper-text">Max concurrent LoRA adapters</small>
                        </div>

                        <div class="form-group">
                            <label for="max-lora-rank">Max LoRA Rank</label>
                            <input type="number"
                                   id="max-lora-rank"
                                   value="{{ vllm_config.max_lora_rank }}"
                                   min="1"
                                   max="128"
                                   class="input-field">
                            <small class="helper-text">Maximum LoRA rank</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="lora-dtype">LoRA Data Type</label>
                            <select id="lora-dtype" class="input-field">
                                <option value="auto" {% if vllm_config.lora_dtype == 'auto' %}selected{% endif %}>auto</option>
                                <option value="float16" {% if vllm_config.lora_dtype == 'float16' %}selected{% endif %}>float16</option>
                                <option value="bfloat16" {% if vllm_config.lora_dtype == 'bfloat16' %}selected{% endif %}>bfloat16</option>
                                <option value="float32" {% if vllm_config.lora_dtype == 'float32' %}selected{% endif %}>float32</option>
                            </select>
                            <small class="helper-text">LoRA weights precision</small>
                        </div>

                        <div class="form-group">
                            <label for="max-cpu-loras">Max CPU LoRAs</label>
                            <input type="number"
                                   id="max-cpu-loras"
                                   value="{{ vllm_config.max_cpu_loras or '' }}"
                                   placeholder="Auto"
                                   min="0"
                                   class="input-field">
                            <small class="helper-text">LoRAs cached in CPU memory</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grid for Chat and Control Panel -->
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
            
            <!-- Chat Test Interface -->
            <div class="card">
                <h2 class="section-title">ü§ñ Test Chat Interface</h2>
            <div class="chat-container">
                <div class="chat-input-group">
                    <textarea id="chat-prompt" 
                              class="chat-textarea" 
                              placeholder="Enter your prompt here..."
                              rows="4"></textarea>
                    <div class="chat-controls">
                        <button type="button" class="btn-primary" onclick="sendChatMessage()">
                            Send Message
                        </button>
                        <button type="button" class="btn-secondary" onclick="clearChat()">
                            Clear
                        </button>
                    </div>
                </div>
                
                <div id="chat-response" class="chat-response" style="display: none;">
                    <h3 style="margin-bottom: 0.5rem;">Response:</h3>
                    <div id="chat-response-text" class="response-text"></div>
                </div>
                
                <div id="chat-metrics" class="chat-metrics" style="display: none;">
                    <h3 style="margin-bottom: 0.5rem;">Performance Metrics:</h3>
                    <div class="metrics-grid">
                        <div class="metric-item">
                            <span class="metric-label">Latency:</span>
                            <span id="metric-latency" class="metric-value">-</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Throughput:</span>
                            <span id="metric-throughput" class="metric-value">-</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Prompt Tokens:</span>
                            <span id="metric-prompt-tokens" class="metric-value">-</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Completion Tokens:</span>
                            <span id="metric-completion-tokens" class="metric-value">-</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Total Tokens:</span>
                            <span id="metric-total-tokens" class="metric-value">-</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Time:</span>
                            <span id="metric-time" class="metric-value">-</span>
                        </div>
                    </div>
                </div>
                
                <div id="chat-loading" class="chat-loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <span>Processing your request...</span>
                </div>
                
                <div id="chat-error" class="status-message error" style="display: none;"></div>
            </div>
        </div>

            <!-- Network Configuration Section -->
            <div class="card">
                <h2 class="section-title">üåê Network Settings</h2>
                <div class="form-group">
                    <label for="host">Host</label>
                    <input type="text"
                           id="host"
                           value="{{ vllm_config.host }}"
                           class="input-field">
                    <small class="helper-text">Use 0.0.0.0 for all interfaces</small>
                </div>
                <div class="form-group">
                    <label for="port">Port</label>
                    <input type="number"
                           id="port"
                           value="{{ vllm_config.port }}"
                           min="1"
                           max="65535"
                           class="input-field">
                    <small class="helper-text">API server port (default: 5002)</small>
                </div>
            </div>
            
        </div> <!-- End grid -->

        <!-- Benchmark Section -->
        <div class="card" style="margin-bottom: 1.5rem;">
            <h2 class="section-title">üìä Benchmark Tests</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                Run performance tests on your vLLM model to measure latency, throughput, and concurrent handling.
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <button type="button" class="btn-primary" onclick="runBenchmark('quick')">
                    Quick Test
                    <small style="display: block; font-weight: normal; margin-top: 0.25rem;">Latency only (~10 requests)</small>
                </button>
                <button type="button" class="btn-secondary" onclick="runBenchmark('standard')">
                    Standard Test
                    <small style="display: block; font-weight: normal; margin-top: 0.25rem;">Latency + Concurrent + Throughput</small>
                </button>
                <button type="button" class="btn-secondary" onclick="runBenchmark('full')">
                    Full Test
                    <small style="display: block; font-weight: normal; margin-top: 0.25rem;">All tests including stress</small>
                </button>
                <button type="button" class="btn-secondary" onclick="runBenchmark('stress')">
                    Stress Test
                    <small style="display: block; font-weight: normal; margin-top: 0.25rem;">Find breaking point</small>
                </button>
            </div>
            
            <!-- Benchmark Loading Indicator -->
            <div id="benchmark-loading" class="chat-loading" style="display: none;">
                <div class="loading-spinner"></div>
                <span id="benchmark-loading-text">Running benchmark tests...</span>
            </div>
            
            <!-- Benchmark Error Display -->
            <div id="benchmark-error" class="status-message error" style="display: none;"></div>
            
            <!-- Benchmark Results Display -->
            <div id="benchmark-results" style="display: none;">
                <h3 style="margin: 1rem 0 0.5rem;">Test Results</h3>
                <div id="benchmark-results-content" style="background: var(--background); padding: 1rem; border-radius: 6px; border: 1px solid var(--border-color); font-family: monospace; white-space: pre-wrap;"></div>
            </div>
        </div>

        <!-- Raw JSON Editor Toggle -->
        <div style="margin-top: 1.5rem; text-align: center;">
            <button type="button" class="btn-toggle" onclick="toggleRawEditor()">
                <span id="toggle-text">Show Raw JSON Editor</span>
            </button>
        </div>

        <!-- Raw JSON Editor (Hidden by default) -->
        <div id="raw-editor" class="raw-editor-container" style="display: none;">
            <div class="card">
                <h2 class="section-title">Raw Configuration Editor</h2>
                <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1rem;">
                    ‚ö†Ô∏è Advanced: Edit the raw JSON configuration directly.
                </p>
                <textarea id="raw-config-textarea" class="raw-config-textarea" rows="15">{{ vllm_config | tojson(indent=2) }}</textarea>
                <div class="raw-editor-buttons">
                    <button type="button" class="btn-primary" onclick="saveRawConfig()">Save Raw Config</button>
                    <button type="button" class="btn-secondary" onclick="cancelRawEdit()">Cancel</button>
                </div>
                <div id="raw-editor-status" class="status-message"></div>
            </div>
        </div>

        <!-- Bottom Grid for API and Raw Editor -->
        <div style="display: grid; grid-template-columns: 1fr; gap: 1.5rem;">
            
            <!-- API Endpoints Info -->
            <div class="card" style="border: 1px solid #667eea;">
                <h2 class="section-title">üîå API Endpoints</h2>
            <div style="font-family: 'Courier New', monospace; background: #1a1a1a; padding: 1.5rem; border-radius: 8px; border: 1px solid #333;">
                <p style="margin: 0.75rem 0; color: #4ade80; font-size: 0.9rem;">
                    <span style="color: #888;">BASE URL:</span> 
                    <span style="color: #60a5fa;">http://{{ request.host }}</span>
                </p>
                <hr style="border: none; border-top: 1px solid #333; margin: 1rem 0;">
                <p style="margin: 0.5rem 0; color: #fff; font-size: 0.85rem;">
                    <span style="color: #fbbf24;">GET</span> 
                    <span style="color: #a5b4fc;">/v1/models</span>
                    <span style="color: #888;">‚Äî List models</span>
                </p>
                <p style="margin: 0.5rem 0; color: #fff; font-size: 0.85rem;">
                    <span style="color: #4ade80;">POST</span> 
                    <span style="color: #a5b4fc;">/v1/completions</span>
                    <span style="color: #888;">‚Äî Completions</span>
                </p>
                <p style="margin: 0.5rem 0; color: #fff; font-size: 0.85rem;">
                    <span style="color: #4ade80;">POST</span> 
                    <span style="color: #a5b4fc;">/v1/chat/completions</span>
                    <span style="color: #888;">‚Äî Chat</span>
                </p>
                <hr style="border: none; border-top: 1px solid #333; margin: 1rem 0;">
                <p style="margin: 0.5rem 0; color: #888; font-size: 0.75rem;">EXAMPLE CURL COMMAND:</p>
                <div style="background: #0d0d0d; padding: 1rem; border-radius: 6px; margin-top: 0.5rem; overflow-x: auto;">
                    <pre style="margin: 0; color: #a5b4fc; font-size: 0.75rem; line-height: 1.4;">curl -X POST http://{{ request.host }}/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{
    "model": "{{ vllm_config.model }}",
    "messages": [
      {"role": "user", "content": "Hello, how are you?"}
    ],
    "temperature": 0.7,
    "max_tokens": 512
  }'</pre>
                </div>
            </div>
        </div>
            
        </div> <!-- End bottom grid -->
        
    </div> <!-- End container -->

    <script>
        // Set API base URL for fetch requests (empty for same origin)
        window.API_BASE = "";
    </script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>